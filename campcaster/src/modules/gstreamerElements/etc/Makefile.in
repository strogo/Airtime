#-------------------------------------------------------------------------------
#   Copyright (c) 2004 Media Development Loan Fund
#
#   This file is part of the Campcaster project.
#   http://campcaster.campware.org/
#   To report bugs, send an e-mail to bugs@campware.org
#
#   Campcaster is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   Campcaster is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with Campcaster; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
#
#   Author   : $Author$
#   Version  : $Revision$
#   Location : $URL$
#
#   @configure_input@
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
#   General command definitions
#-------------------------------------------------------------------------------
MKDIR   = mkdir -p
RM      = rm -f
RMDIR   = rm -rf
DOXYGEN = doxygen
CP      = cp -f


#-------------------------------------------------------------------------------
#   Basic directory and file definitions
#-------------------------------------------------------------------------------
PACKAGE_NAME = @PACKAGE_NAME@

BASE_DIR     = @builddir@
DOC_DIR      = ${BASE_DIR}/doc
DOXYGEN_DIR  = ${DOC_DIR}/doxygen
COVERAGE_DIR = ${DOC_DIR}/coverage
ETC_DIR      = ${BASE_DIR}/etc
INCLUDE_DIR  = ${BASE_DIR}/include
LIB_DIR      = ${BASE_DIR}/lib
SRC_DIR      = ${BASE_DIR}/src
TMP_DIR      = ${BASE_DIR}/tmp
VAR_DIR      = ${BASE_DIR}/var

REAL_BASE_DIR=$(shell cd ${BASE_DIR}; pwd)


prefix = @prefix@

USR_DIR         = ${prefix}
USR_INCLUDE_DIR = ${USR_DIR}/include
USR_BIN_DIR     = ${USR_DIR}/bin
USR_LIB_DIR     = ${USR_DIR}/lib

MODULES_DIR     = ${BASE_DIR}/..

CORE_DIR         = ${MODULES_DIR}/core
CORE_INCLUDE_DIR = ${CORE_DIR}/include
CORE_LIB_DIR     = ${CORE_DIR}/lib
CORE_LIB         = livesupport_core
CORE_LIB_FILE    = ${CORE_LIB_DIR}/lib${CORE_LIB}.a

VPATH    = ${SRC_DIR}

BOOST_CFLAGS=@BOOST_CPPFLAGS@
BOOST_LIBS=@BOOST_LDFLAGS@
BOOST_DATE_TIME_LIB=@BOOST_DATE_TIME_LIB@

GSTREAMER_CFLAGS=@GSTREAMER_CFLAGS@
GSTREAMER_LIBS=@GSTREAMER_LIBS@
GST_REGISTER=@GST_REGISTER@

TEST_RESULTS = ${DOC_DIR}/testResults.xml
# the text result XSLT has to be relative to the test result file, e.g. TMP_DIR
TEST_XSLT    = ../etc/testResultToHtml.xsl

GSTREAMER_ELEMENTS_LIB		= livesupport_gstreamerelements
GSTREAMER_ELEMENTS_LIB_FILE = ${LIB_DIR}/lib${GSTREAMER_ELEMENTS_LIB}.a

ONESHOT_READER_LIB          = livesupport_oneshotreader
ONESHOT_READER_LIB_FILE     = ${LIB_DIR}/lib${ONESHOT_READER_LIB}.so
MINIMAL_AUDIO_SMIL_LIB      = livesupport_minimalaudiosmil
MINIMAL_AUDIO_SMIL_LIB_FILE = ${LIB_DIR}/lib${MINIMAL_AUDIO_SMIL_LIB}.so
PARTIAL_PLAY_LIB            = livesupport_partialplay
PARTIAL_PLAY_LIB_FILE       = ${LIB_DIR}/lib${PARTIAL_PLAY_LIB}.so
SWITCHER_LIB            	= livesupport_switcher
SWITCHER_LIB_FILE       	= ${LIB_DIR}/lib${SWITCHER_LIB}.so

TEST_RUNNER        = ${TMP_DIR}/testRunner
PLAY               = ${TMP_DIR}/play

DOXYGEN_CONFIG = ${ETC_DIR}/doxygen.config

export LD_LIBRARY_PATH:=${USR_LIB_DIR}:${LD_LIBRARY_PATH}
export GST_PLUGIN_PATH=${REAL_BASE_DIR}/lib


#-------------------------------------------------------------------------------
#  	Configuration parameters
#-------------------------------------------------------------------------------
CPPFLAGS = @CPPFLAGS@
CFLAGS = @CFLAGS@ @DEFS@ @COVERAGE_CXXFLAGS@ -pthread \
                             -pedantic -Wall -std=c99 -Wno-long-long \
							 -fPIC -DPIC \
                             ${GSTREAMER_CFLAGS} \
                             -I${USR_INCLUDE_DIR} \
                             -I${INCLUDE_DIR} -I${TMP_DIR}
CXXFLAGS = @CXXFLAGS@ @DEFS@ @COVERAGE_CXXFLAGS@ -pthread \
                             -Wall -Wno-long-long \
                             ${BOOST_CFLAGS} \
                             ${GSTREAMER_CFLAGS} \
                             -I${USR_INCLUDE_DIR} \
                             -I${CORE_INCLUDE_DIR} \
                             -I${INCLUDE_DIR} -I${TMP_DIR}
GST_LDFLAGS  = @LDFLAGS@  ${GSTREAMER_LIBS} \
                          -L${USR_LIB_DIR} \
                          -L${LIB_DIR}
LDFLAGS  = @LDFLAGS@ ${GSTREAMER_LIBS} \
                     ${BOOST_LIBS} \
					 -L${USR_LIB_DIR} \
                     -L${CORE_LIB_DIR} \
                     -L${LIB_DIR}


#-------------------------------------------------------------------------------
#	Dependencies
#-------------------------------------------------------------------------------
GSTREAMER_ELEMENTS_LIB_OBJS = ${TMP_DIR}/seek.o \
                   			  ${TMP_DIR}/util.o \
                   			  ${TMP_DIR}/seek-pack.o \
				   			  ${TMP_DIR}/autoplug.o \
							  ${TMP_DIR}/smil-util.o

ONESHOT_READER_LIB_OBJS = ${TMP_DIR}/oneshot-reader.o

MINIMAL_AUDIO_SMIL_LIB_OBJS = ${TMP_DIR}/minimal-audio-smil.o

PARTIAL_PLAY_LIB_OBJS = ${TMP_DIR}/partial-play.o

SWITCHER_LIB_OBJS = ${TMP_DIR}/switcher.o

TEST_RUNNER_OBJS = ${TMP_DIR}/TestRunner.o \
                   ${TMP_DIR}/AutoplugTest.o 
DONT_TEST=         ${TMP_DIR}/AutoplugTest.o \
                   ${TMP_DIR}/SeekTest.o \
                   ${TMP_DIR}/SwitcherTest.o \
                   ${TMP_DIR}/SeekPackTest.o \
                   ${TMP_DIR}/PartialPlayTest.o \
                   ${TMP_DIR}/OneshotReaderTest.o \
				   ${TMP_DIR}/MinimalAudioSmilTest.o 

TEST_RUNNER_LIBS = -l${GSTREAMER_ELEMENTS_LIB} -l${CORE_LIB} \
                   ${BOOST_DATE_TIME_LIB} \
                   -lcppunit -ldl -lxmlrpc++

PLAY_OBJS = ${TMP_DIR}/play.o

PLAY_LIBS = -l${GSTREAMER_ELEMENTS_LIB} -l${CORE_LIB}


#-------------------------------------------------------------------------------
#   Targets
#-------------------------------------------------------------------------------
.PHONY: all dir_setup doc clean docclean depclean distclean check install

all: dir_setup ${GSTREAMER_ELEMENTS_LIB_FILE} \
               ${ONESHOT_READER_LIB_FILE} \
               ${MINIMAL_AUDIO_SMIL_LIB_FILE} \
               ${PARTIAL_PLAY_LIB_FILE} \
               ${SWITCHER_LIB_FILE} \
			   ${PLAY} \
     gst_register

dir_setup: ${TMP_DIR} ${DOXYGEN_DIR}


gst_register:
	${GST_REGISTER} > /dev/null 2>&1

doc:
	${DOXYGEN} ${DOXYGEN_CONFIG}

clean:
	${RM} ${GSTREAMER_ELEMENTS_LIB_OBJS} ${GSTREAMER_ELEMENTS_LIB_FILE}
	${RM} ${ONESHOT_READER_LIB_OBJS} ${ONESHOT_READER_LIB_FILE}
	${RM} ${MINIMAL_AUDIO_SMIL_LIB_OBJS} ${MINIMAL_AUDIO_SMIL_LIB_FILE}
	${RM} ${PARTIAL_PLAY_LIB_OBJS} ${PARTIAL_PLAY_LIB_FILE}
	${RM} ${SWITCHER_LIB_OBJS} ${SWITCHER_LIB_FILE}
	${RM} ${TEST_RUNNER_OBJS} ${TEST_RUNNER_RES} ${TEST_RUNNER}
	${RM} ${PLAY_OBJS} ${PLAY}
	${RM} ${TMP_DIR}/*.bb ${TMP_DIR}/*.bbg ${TMP_DIR}/*.da ${TMP_DIR}/*.info

docclean:
	${RMDIR} ${DOXYGEN_DIR}/html
	${RMDIR} ${COVERAGE_DIR}/*
	${RM} ${TEST_RESULTS}

depclean: clean

distclean: clean docclean
	${RMDIR} ${TMP_DIR}/config* ${TMP_DIR}/autom4te* ${TMP_DIR}/ac*.m4

check: all ${TEST_RUNNER}
	${TEST_RUNNER} -o ${TEST_RESULTS} -s ${TEST_XSLT}

install: all
	${MKDIR} ${USR_INCLUDE_DIR}/LiveSupport/GstreamerElements
	${CP} ${INCLUDE_DIR}/LiveSupport/GstreamerElements/*.h \
          ${USR_INCLUDE_DIR}/LiveSupport/GstreamerElements
	${CP} ${GSTREAMER_ELEMENTS_LIB_FILE} \
          ${ONESHOT_READER_LIB_FILE} \
          ${MINIMAL_AUDIO_SMIL_LIB_FILE} \
          ${PARTIAL_PLAY_LIB_FILE} \
          ${SWITCHER_LIB_FILE} \
		  ${USR_LIB_DIR}
	-GST_PLUGIN_PATH=${USR_LIB_DIR} ${GST_REGISTER}


#-------------------------------------------------------------------------------
#   Specific targets
#-------------------------------------------------------------------------------
${GSTREAMER_ELEMENTS_LIB_FILE}: ${GSTREAMER_ELEMENTS_LIB_OBJS}
	${AR} crus $@ $^

${ONESHOT_READER_LIB_FILE}: ${ONESHOT_READER_LIB_OBJS} \
                            ${GSTREAMER_ELEMENTS_LIB_FILE}
	${CC} -shared -o $@ $^ ${GST_LDFLAGS}

${MINIMAL_AUDIO_SMIL_LIB_FILE}: ${MINIMAL_AUDIO_SMIL_LIB_OBJS} \
					      		${GSTREAMER_ELEMENTS_LIB_FILE}
	${CC} -shared -o $@ $^ ${GST_LDFLAGS}

${PARTIAL_PLAY_LIB_FILE}: ${PARTIAL_PLAY_LIB_OBJS} \
					      ${GSTREAMER_ELEMENTS_LIB_FILE}
	${CC} -shared -o $@ $^ ${GST_LDFLAGS}

${SWITCHER_LIB_FILE}: ${SWITCHER_LIB_OBJS} \
					  ${GSTREAMER_ELEMENTS_LIB_FILE}
	${CC} -shared -o $@ $^ ${GST_LDFLAGS}

${TMP_DIR}:
	${MKDIR} ${TMP_DIR}

${DOXYGEN_DIR}:
	${MKDIR} ${DOXYGEN_DIR}

${TEST_RUNNER}: ${CORE_LIB_FILE} ${GSTREAMER_ELEMENTS_LIB_FILE} \
                ${TEST_RUNNER_OBJS}
	${CXX} ${LDFLAGS} -o $@ ${TEST_RUNNER_OBJS} ${TEST_RUNNER_LIBS}

${PLAY}: ${CORE_LIB_FILE} ${GSTREAMER_ELEMENTS_LIB_FILE} ${PLAY_OBJS}
	${CXX} ${LDFLAGS} -o $@ ${PLAY_OBJS} ${PLAY_LIBS}

${CORE_LIB_FILE}:
	${MAKE} -C ${CORE_DIR}


#-------------------------------------------------------------------------------
#   Pattern rules
#-------------------------------------------------------------------------------
${TMP_DIR}/%.o : ${SRC_DIR}/%.c
	${CC} ${CPPFLAGS} ${CFLAGS} -c -o $@ $<

${TMP_DIR}/%.o : ${SRC_DIR}/%.cxx
	${CXX} ${CPPFLAGS} ${CXXFLAGS} -c -o $@ $<

